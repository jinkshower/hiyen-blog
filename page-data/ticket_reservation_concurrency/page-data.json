{"componentChunkName":"component---src-templates-post-jsx","path":"/ticket_reservation_concurrency/","result":{"data":{"site":{"siteMetadata":{"title":"Hiyen"}},"markdownRemark":{"id":"78a00267-c3db-5594-a5f3-621906fc030d","excerpt":"학습 계기 콘서트 티켓 예매 프로젝트를 진행하는 중 동시에 많은 사용자가 한 자리의 좌석을 예매할 시 여러개의 같은 예약이 생성되는 문제를 발견했습니다. 콘서트 예매 상황을 생각해보면 굉장히 흔한 일인데요, '이미 선택된 좌석입니다'라는 메시지를 한번쯤은 보신 기억이 있을 거라 생각됩니다. 해당 문제를 해결하기 위해 jpa의 낙관적 락, 비관적락을 적용해…","html":"<h2>학습 계기</h2>\n<p>콘서트 티켓 예매 프로젝트를 진행하는 중 동시에 많은 사용자가 한 자리의 좌석을 예매할 시 여러개의 같은 예약이 생성되는 문제를 발견했습니다.</p>\n<p>콘서트 예매 상황을 생각해보면 굉장히 흔한 일인데요, '이미 선택된 좌석입니다'라는 메시지를 한번쯤은 보신 기억이 있을 거라 생각됩니다.</p>\n<p>해당 문제를 해결하기 위해 jpa의 낙관적 락, 비관적락을 적용해보고 다른 방식으로 문제를 해결한 기록을 공유하고자 합니다.</p>\n<h2>예매 코드와 테스트 코드</h2>\n<p>예매 로직을 수행하는 코드를 살펴보고 갈까요?(실제 코드와 다를 수 있습니다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> concertId<span class=\"token punctuation\">,</span>  \n    <span class=\"token class-name\">ReservationRequestDto</span> requestDto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token class-name\">Seat</span> seat <span class=\"token operator\">=</span> seatRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findSeatForReservation</span><span class=\"token punctuation\">(</span>concertId<span class=\"token punctuation\">,</span>  \n        requestDto<span class=\"token punctuation\">.</span><span class=\"token function\">getHorizontal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requestDto<span class=\"token punctuation\">.</span><span class=\"token function\">getVertical</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>seat<span class=\"token punctuation\">.</span><span class=\"token function\">isReservable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomRuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"예약 불가능한 좌석입니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n    seat<span class=\"token punctuation\">.</span><span class=\"token function\">reserve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token class-name\">Reservation</span> reservation <span class=\"token operator\">=</span> <span class=\"token class-name\">Reservation</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Y\"</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">userId</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">concertId</span><span class=\"token punctuation\">(</span>concertId<span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">seatId</span><span class=\"token punctuation\">(</span>seat<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\treservationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>저희는 콘서트의 좌석을 행과 열로 관리하고 있기때문에 findSeatForReservation()을 통해서 해당 콘서트의 id, 행열 정보로 seat를 찾고 seat가 예약 가능한지 살펴보고 예약이 가능하다면 seat의 예약 필드를 바꾸고 reservation을 만드는 로직을 사용하고 있습니다.</p>\n<p>1번 콘서트의 A-1이라는 좌석을 20명의 사용자가 동시에 예매하는 테스트 코드를 작성해보았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"동시에 한자리 예매시 첫번째 요청만 예매성공한다.\"</span><span class=\"token punctuation\">)</span>  \n<span class=\"token annotation punctuation\">@Test</span>  \n<span class=\"token keyword\">void</span> <span class=\"token function\">concurrency_test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token comment\">//given  </span>\n    <span class=\"token keyword\">int</span> tryCount <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">long</span> userId <span class=\"token operator\">=</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">Long</span> concertId <span class=\"token operator\">=</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">ReservationRequestDto</span> reservationRequestDto <span class=\"token operator\">=</span> <span class=\"token class-name\">ReservationRequestDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">horizontal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">vertical</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">ExecutorService</span> executor <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token comment\">//when  </span>\n    <span class=\"token class-name\">CountDownLatch</span> latch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span>tryCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> tryCount<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">int</span> finalI <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>  \n        executor<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n                reservationService<span class=\"token punctuation\">.</span><span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span>userId <span class=\"token operator\">+</span> finalI<span class=\"token punctuation\">,</span> concertId<span class=\"token punctuation\">,</span>  \n                    reservationRequestDto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n                log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>  \n                latch<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span>  \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n    latch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token comment\">//then  </span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>reservationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>테스트 결과는 실패였습니다.</p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/3a81b97d-faa2-4c7c-ad5f-5afd2b0b3569\" alt=\"Pasted image 20240407111517\">\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/b5088e14-d8e8-4eb0-b05a-a97c368552e1\" alt=\"Pasted image 20240407111531\"></p>\n<p>왜 이런일이 일어난걸까요?</p>\n<h2>동시성 문제</h2>\n<p>동시성 제어를 하지 않은 현재의 경우 2개의 스레드만을 생각해보면, Thread1이 seat를 조회하는 동안 Thread2도 seat를 조회할 수 있습니다.</p>\n<p>Thread1이 seat의 예약 상태를 바꾸기 전에 Thread2도 예약 상태를 조회할 수 있기 때문에 결국 update를 두개의 스레드들이 모두 수행할 수 있고 예약이 동시에 seat에 접근한 스레드의 수(10개)만큼 생성될 수 있습니다.</p>\n<p>이 문제를 해결하려면 먼저 들어온 요청이 끝나기 전까지 다른 스레드들은 seat의 정보를 읽어서는 안됩니다.</p>\n<p>즉 seat의 예약상태를 임계영역(Critical Section)으로 보고 스레드들의 경쟁상태(Race Condition)을 제어해줄 필요가 있습니다.</p>\n<h2>Synchronized</h2>\n<p>자바는 <code class=\"language-text\">synchronized</code> 키워드를 사용하여 스레드 간의 임계 영역을 보호할 수 있습니다. <code class=\"language-text\">synchronized</code>를 사용하면 한 번에 하나의 스레드만이 해당 블록 또는 메서드에 진입할 수 있습니다. 이를 통해 동시성 문제를 해결할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> concertId<span class=\"token punctuation\">,</span>  \n    <span class=\"token class-name\">ReservationRequestDto</span> requestDto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token class-name\">Seat</span> seat <span class=\"token operator\">=</span> seatRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findSeatForReservation</span><span class=\"token punctuation\">(</span>concertId<span class=\"token punctuation\">,</span>  \n        requestDto<span class=\"token punctuation\">.</span><span class=\"token function\">getHorizontal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requestDto<span class=\"token punctuation\">.</span><span class=\"token function\">getVertical</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>seat<span class=\"token punctuation\">.</span><span class=\"token function\">isReservable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomRuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"예약 불가능한 좌석입니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n    seat<span class=\"token punctuation\">.</span><span class=\"token function\">reserve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token class-name\">Reservation</span> reservation <span class=\"token operator\">=</span> <span class=\"token class-name\">Reservation</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Y\"</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">userId</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">concertId</span><span class=\"token punctuation\">(</span>concertId<span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">seatId</span><span class=\"token punctuation\">(</span>seat<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\treservationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>간단하게 예매 메서드에 synchronized 키워드를 추가하면 자바가 제공하는 동시성 제어를 사용할 수 있습니다.</p>\n<p>하지만 테스트는 실패합니다.</p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/346b5654-6179-4ea8-a628-dc3d4c4c9316\" alt=\"Pasted image 20240407111955\">\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/3303dd96-84fc-475c-8102-d0642513045a\" alt=\"Pasted image 20240407112022\"></p>\n<h3>synchronized의 문제점</h3>\n<p>synchronized는 @Transactional과 함께 사용시 동시성을 제대로 제어할 수 없습니다.</p>\n<p>이를 위해서는 @Transactional에 대한 이해가 필요한데요.</p>\n<p>@Transactional은 해당 어노테이션이 붙은 메서드에 트랜잭션 환경을 제공하기 위해 프록시 메서드를 만들고 그 프록시 메서드에서 실제 트랜잭션을 시작하고 종료하는 작업을 처리합니다.</p>\n<p>이 때 실제 메서드에서 쓰이는 synchronized 키워드는 프록시 메서드에 적용되지 않습니다.</p>\n<p>(간단하게 재현해본 @Transactional의 프록시 메서드)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TransactionalProxy</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// 프록시 메서드</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">invokeTransactionalMethod</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> method<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 트랜잭션 시작</span>\n            method<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 트랜잭션 커밋</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>즉 트랜잭션 시작과 커밋을 담당하는 프록시 메서드가 한 스레드만 접근하는 것을 보장하지 못하기 때문에 동시성 문제를 synchronized로는 해결 할 수 없습니다.</p>\n<h2>락</h2>\n<p>해당 문제를 해결하기 위해 JPA가 제공하는 락의 기능에 대해 알아보고 적용해봤습니다.</p>\n<h2>낙관적 락</h2>\n<p>낙관적 락은 여러 트랜잭션의 충돌이 적을 것을 낙관적으로 가정하고 JPA가 제공하는 버전 관리 기능을 사용하는 것입니다.</p>\n<p>낙관적 락을 적용하는 방법은 간단합니다.\n낙관적 락이 필요한 엔티티에 @Version 어노테이션을 추가해주면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Version</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> version<span class=\"token punctuation\">;</span></code></pre></div>\n<p>이제 해당 엔티티는 수정할때마다 버전이 하나씩 자동으로 증가하고 엔티티를 수정할 때 조회 시점 버전과 다르다면 예외를 발생시킵니다.</p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/7cba894a-6068-49c0-bd3b-23e68c0d5119\" alt=\"Pasted image 20240408113751\">\n따라서 낙관적 락을 사용하면 최초의 커밋만 인정되고 나머지 트랜잭션은 예외가 발생하기 때문에 동시성을 제어할 수 있게 됩니다.</p>\n<p>낙관적 락을 적용하고 테스트를 해보았습니다.</p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/e187e197-959d-4937-89b3-b4c8a6743e4b\" alt=\"Pasted image 20240407115641\">\nwhere절의 version이 보이시나요? 해당 쿼리는 seat.reserve()를 할때  발생하는 update 쿼리로 조회시의 버전과 update시점의 버전이 다르면 예외를 발생시킵니다.</p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/2a600f34-5f40-4ce2-9db1-ebb0674f548f\" alt=\"Pasted image 20240407115601\"></p>\n<p>테스트 결과는 통과입니다.\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/ab541c3e-948f-4a77-924b-14759d767db8\" alt=\"Pasted image 20240407115717\"></p>\n<h2>비관적 락</h2>\n<p>비관적 락은 여러 트랜잭션의 충돌이 일어날 것을 비관적으로 가정하고 우선 데이터베이스 락 메커니즘을 사용하여 해당 row에 락을 거는 방법입니다.</p>\n<p>비관적 락의 적용방법도 간단한데요</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PESSIMISTIC_WRITE</span><span class=\"token punctuation\">)</span>  \n<span class=\"token class-name\">Seat</span> <span class=\"token function\">findSeatForReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> concertId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> horizontal<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> vertical<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>데이터베이스에 PESSIMISTIC_WRITE로 쓰기 락을 걸 수 있습니다.</p>\n<p>비관적 락을 위와 같이 설정하면 위의 메서드를 사용하여 seat를 조회할때 그냥 select대신 <code class=\"language-text\">select for update</code>로 조회하고 해당 데이터에 배타적 lock을 걸어 lock을 획득한 트랜잭션의 update가 실행될 때까지 다른 트랜잭션의 데이터 조회를 막을 수 있습니다. </p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/dd47c914-1d6d-4863-9d15-c90882fae4c1\" alt=\"Pasted image 20240407121851\"></p>\n<p><img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/66fedf8e-cc45-4114-a7d5-4f8718e02fd3\" alt=\"Pasted image 20240407123606\"></p>\n<p>테스트 또한 통과합니다.</p>\n<h2>그럼 둘 중에 뭘써야할까?</h2>\n<p>두 방식 모두 동시성을 원하는대로 제어할 수 있다고 판단하고 jmeter를 통해 성능을 측정해보았습니다.</p>\n<p>낙관적 락\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/329add37-b716-456c-a34e-031007976aec\" alt=\"Pasted image 20240407165746\"></p>\n<p>비관적 락\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/7684d545-ae5c-4ec8-bf58-c311ede787a1\" alt=\"Pasted image 20240407165805\"></p>\n<p>성능 면에서는 비관적락이 낙관적 락보다 조금 더 낫지만 그렇게 큰 차이가 아니라고 판단했습니다.</p>\n<p>하지만 낙관적 락, 비관적 락은 동시성 제어라는 목표를 달성했지만 프로젝트에 적용하기에는 무리가 있다고 판단했습니다. </p>\n<p>현재 프로젝트의 비즈니스 로직에서 첫번째로 좌석을 예매하는 요청이 오면 다른 요청은 모두 예외로 처리하면 됩니다. </p>\n<p>하지만 낙관적락은 update, 비관적 락은 select for update쿼리가 스레드 요청만큼 발생하게 됩니다. db에 요청 수만큼  쿼리가 날아가면 부하가 심해질 것입니다.</p>\n<p>또한 두 방식 모두 분산DB환경에서는 적용이 되지 않는 단점이 있습니다.</p>\n<h2>db에 부하를 주지 않는 방법은 없을까?</h2>\n<p>앞서 말한대로 첫번째 좌석을 예매하는 요청이외의 다른 스레드의 요청을 예외처리하면 db에 쿼리를 날리지 않고도 예매로직을 실현할 수 있을 거라 생각했습니다.</p>\n<p>이를 위해 Java의 Map과 같은 구조로 좌석의 정보를 key값으로 설정하고 해당 key가 있으면 예외로 처리하면 되지 않을까라는 생각을 하게 되었습니다.</p>\n<h2>Redis</h2>\n<p><code class=\"language-text\">해당 방법은 redis의 분산락을 사용하는 것이 아니라 redis의 자료구조의 성질을 이용합니다</code></p>\n<p>Redis는 인메모리 데이터베이스로서 데이터를 메모리에 저장하므로 빠른 응답 속도를 제공합니다.</p>\n<p>redis를 활용하면 분산DB환경에서도 따로 동작하는 공통의 db가 생기는 것이기 때문에 예매 로직이 문제없이 실행될 것이라 생각했습니다.</p>\n<h3>redis 적용하기</h3>\n<p><code class=\"language-text\">redis 설정과 명령어는 좀더 학습한 후 다른 포스트에서 자세히 다룰 예정입니다.</code></p>\n<p>redis에는 <code class=\"language-text\">SETNX</code>라는 명령어가 존재합니다. 'SET if Not eXits'의 줄임말로 특정 Key에 Value가 존재하지 않을 때만 값을 설정할수 있는 명령어입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token number\">127.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span><span class=\"token operator\">:</span><span class=\"token number\">6379</span><span class=\"token operator\">></span> setnx <span class=\"token number\">1</span><span class=\"token constant\">A1</span> reserved\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span>\n<span class=\"token number\">127.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span><span class=\"token operator\">:</span><span class=\"token number\">6379</span><span class=\"token operator\">></span> setnx <span class=\"token number\">1</span><span class=\"token constant\">A1</span> reserved\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">0</span></code></pre></div>\n<p>이를 이용하여 첫번째 요청시에 concertId + 행열정보로 key를 설정하고 다른 요청에서 같은 key로 요청시 응답이 다른 redis의 성질을 이용하면 될 것이라 생각했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isTaken</span><span class=\"token punctuation\">(</span>concertId<span class=\"token punctuation\">,</span> requestDto<span class=\"token punctuation\">.</span><span class=\"token function\">getHorizontal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requestDto<span class=\"token punctuation\">.</span><span class=\"token function\">getVertical</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomRuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"이미 예약된 좌석입니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">Boolean</span> <span class=\"token function\">isTaken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> concertId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> horizontal<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> vertical<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token class-name\">String</span> key <span class=\"token operator\">=</span> concertId <span class=\"token operator\">+</span> horizontal <span class=\"token operator\">+</span> vertical<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FALSE</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>  \n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setIfAbsent</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token string\">\"reserved\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Spring환경에서 redis를 코드로 활용하기 위하여 RedisTemplate를 @Bean으로 등록해 사용했습니다. </p>\n<p>예매 로직이 실행되기전 isTaken()메서드를 호출하여 <code class=\"language-text\">opsForValue().setIfAbsent()</code>로 concertId +행열을 key로 설정합니다.</p>\n<p>당연히 첫 요청은 위에서 본 것처럼 1이 반환되고 이는 RedisTemplate에서 true로 반환됩니다. 같은 좌석을 예매하는 요청은 0이 반환되고 false가 반환되겠네요!</p>\n<p>해당 메서드를 테스트해보겠습니다.</p>\n<p>테스트는 통과하고\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/db7fce63-f06e-4db9-a8b0-76622d488ad0\" alt=\"Pasted image 20240407193400\"></p>\n<p>애플리케이션에서 redis로 미리 예외처리를 모두 해줬기 때문에 db에 insert쿼리가 단 하나만 날아가는 모습입니다.\n<img src=\"https://github.com/jinkshower/jinkshower.github.io/assets/135244018/73a814d4-47eb-4e08-aca2-88224491cd33\" alt=\"Pasted image 20240407193443\"></p>\n<h2>Redis 꼭 써야돼?</h2>\n<p>사실 락이나 Redis를 쓰지 않고 중복된 예매 생성을 막는 방법이 있습니다.</p>\n<p>바로 Reservation 테이블에 unique constraints를 걸어주는 방법인데요,\nconcert<em>id + seat</em>id 복합unique 설정을 해주면 중복된 예매가 생성되는 것을 막을 수 있습니다</p>\n<p>하지만 해당 방법만을 채택하는 것은 문제가 있다 생각했습니다.</p>\n<p>unique constraints만을 걸어둔다면 물론 같은 예매가 중복생성되지 않을 수 있지만 동시성문제 파트에서 말씀 드린 seat의 예약 상태를 다른 트랜잭션도 읽을 수 있다는 게 문제가 됩니다.</p>\n<p>현재 로직에서는 결제와 같은 로직이 존재하지 않지만, 유저가 포인트를 사용해 예매를 할수 있다면요? </p>\n<p>예매과정은 포인트 차감, 예매생성까지 한 트랜잭션에서 처리해야 하는데 예매가 중복 생성되는 것만을 막는다면 포인트는 차감되지만 예매는 생성되지 않는 문제가 생길 수 있습니다.</p>\n<p>더불어 해당 예매가 unique 인지를 확인해야하는 insert쿼리가 요청수만큼 생성되는 것도 덤이지요.</p>\n<p>따라서 저희는 Redis를 사용해 db에 최소한의 쿼리만을 날아가게 하며 두번째 요청부터는 seat의 예약상태를 못 읽게 하고, unique constraint를 걸어 최후의 보루로 예매 중복생성을 막기로 결정했습니다. </p>\n<h2>마치며</h2>\n<p>이렇게 예매 상황에서 동시성제어를 위해 낙관적락, 비관적락을 살펴보고 비즈니스 로직에 더 적절하고 db에 부하를 주지 않는 Redis를 활용한 기록을 적어보았습니다.</p>\n<p>하지만 Redis도 단점은 분명히 존재합니다. 핵심 비즈니스 로직인 예매 기능이 Redis와 강하게 결부된다는 점, 그리하여 Redis의 서버가 죽는다면 예매 로직이 제대로 기능하지 못한다는 점등이 그러합니다.</p>\n<p>현재 상황에서는 좋은 방안이라고 생각되지만 프로젝트가 진행되면서 해당 기능과 문제 해결점이 다시 변할 수도 있다고 생각됩니다!!</p>","frontmatter":{"title":"'이미 선택된 좌석입니다' 티켓 예매시의 동시성제어","date":"April 08, 2024","update":"April 08, 2024","tags":["concurrency","lock","redis"],"series":"database"},"fields":{"slug":"/ticket_reservation_concurrency/","readingTime":{"minutes":16.57}}},"seriesList":{"edges":[{"node":{"id":"2887bce2-cf4e-59e5-bfba-4e651d9c2ecf","fields":{"slug":"/transaction/"},"frontmatter":{"title":"Transaction"}}},{"node":{"id":"113f66c0-5843-57db-9424-03e366fa222e","fields":{"slug":"/database_index/"},"frontmatter":{"title":"인덱스와 인덱스 적용기"}}},{"node":{"id":"78a00267-c3db-5594-a5f3-621906fc030d","fields":{"slug":"/ticket_reservation_concurrency/"},"frontmatter":{"title":"'이미 선택된 좌석입니다' 티켓 예매시의 동시성제어"}}}]},"previous":{"fields":{"slug":"/docker_githubactions/"},"frontmatter":{"title":"Github Actions, Docker와 함께하는 배포 자동화"}},"next":null},"pageContext":{"id":"78a00267-c3db-5594-a5f3-621906fc030d","series":"database","previousPostId":"3d81f9cd-1c34-5429-b102-07e4e3c0e70f","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}